<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trivia Duel</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{--bg:#0b1020;--card:#111931;--muted:#9bb0d0;--accent:#0ea5e9;--good:#16a34a;--bad:#ef4444}
    *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Helvetica,Arial;background:linear-gradient(180deg,#0b1020,#060a18) fixed;color:#e5edff}
    .wrap{max-width:760px;margin:0 auto;padding:16px 16px 80px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:18px}
    h1{font-size:24px;margin:12px 0 8px} h2{font-size:18px;margin:0 0 8px;color:#bcd1f8}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    input[type=text], input[type=url], input[type=number]{width:100%;background:#0c1224;border:1px solid #243358;color:#e5edff;border-radius:12px;padding:10px}
    button{background:#18264a;border:1px solid #29427a;color:#e5edff;border-radius:14px;padding:10px 14px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#0ea5e9,#0284c7);border-color:#0577b1}
    button:disabled{opacity:.5;cursor:not-allowed}
    .pill{padding:6px 10px;border-radius:999px;background:#0e162e;border:1px solid #23335c;font-size:12px}
    .option{display:flex;gap:10px;align-items:flex-start;background:#0d1530;border:1px solid #23335c;border-radius:14px;padding:10px}
    .alpha{width:26px;height:26px;border-radius:999px;background:#1a2446;display:flex;align-items:center;justify-content:center;font-weight:600}
    .right{border-color:#116b34;background:linear-gradient(180deg,rgba(22,163,74,.18),rgba(22,163,74,.08))}
    .wrong{border-color:#7a1b1b;background:linear-gradient(180deg,rgba(239,68,68,.18),rgba(239,68,68,.08))}
    .footer{position:fixed;inset:auto 0 0 0;background:rgba(3,6,16,.8);backdrop-filter:blur(8px);border-top:1px solid rgba(255,255,255,.08);padding:8px 12px}
    .muted{color:#9bb0d0}
    .tiny{font-size:12px}
    .center{display:flex;justify-content:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="row" style="justify-content:space-between;align-items:center">
      <div>
        <h1>Trivia Duel</h1>
        <div class="muted tiny">Two‑player, adaptive difficulty</div>
      </div>
      <div class="row">
        <div id="installHint" class="pill" style="display:none">Share → Add to Home Screen</div>
        <button id="btnInstall" style="display:none">Install</button>
      </div>
    </header>

    <section class="card" style="margin-top:12px">
      <h2>Setup</h2>
      <div class="row">
        <div class="grow">
          <label class="tiny muted">Player 1</label>
          <input id="name1" type="text" value="Player 1" />
        </div>
        <div class="grow">
          <label class="tiny muted">Player 2</label>
          <input id="name2" type="text" value="Player 2" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="grow">
          <label class="tiny muted">Rounds</label>
          <input id="rounds" type="number" value="12" min="6" max="30" step="2" />
        </div>
        <div class="grow">
          <label class="tiny muted">GPT Proxy URL (optional)</label>
          <input id="proxy" type="url" placeholder="https://your-worker.workers.dev" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnStart" class="primary">Start Game</button>
        <button id="btnDemo">Use Demo Questions</button>
      </div>
      <div class="tiny muted" style="margin-top:6px">Keep your OpenAI key on a server (proxy). Leave URL blank to play offline.</div>
    </section>

    <section id="game" class="card" style="margin-top:14px; display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="tiny muted">Now playing</div>
          <div id="nowPlayer" style="font-weight:700;font-size:18px">—</div>
        </div>
        <div class="row" id="scorePills"></div>
      </div>
      <div class="row" style="margin-top:2px">
        <div class="pill" id="roundPill">Round 1</div>
        <div class="pill" id="diffPill">Easy</div>
      </div>
      <div id="qWrap" style="margin-top:12px">
        <div class="tiny muted" id="qCat">—</div>
        <div id="qText" style="font-size:18px;font-weight:700;line-height:1.3;margin:6px 0 10px">—</div>
        <div id="options"></div>
        <div id="feedback" class="tiny" style="margin-top:8px"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnSkip">Skip</button>
        <div class="grow"></div>
        <button id="btnEnd">End Game</button>
      </div>
    </section>

    <section id="results" class="card" style="margin-top:14px; display:none">
      <h2>Final Scores</h2>
      <div id="scoreList"></div>
      <div class="row" style="margin-top:10px">
        <button id="btnRestart" class="primary">Play Again</button>
      </div>
    </section>

    <footer class="footer row tiny muted">
      <div>Tip: Add to Home Screen for full‑screen play.</div>
      <div class="grow"></div>
      <div id="modeLabel">Mode: Demo</div>
    </footer>
  </div>

  <script>
  const Difficulty = ["Easy","Medium","Hard","Expert","Master"];
  const DIFF_UP_EVERY = 4;

  let cfg = { rounds: 12, proxy: "", options: 4 };
  let players = [{name:"Player 1", score:0, streak:0}, {name:"Player 2", score:0, streak:0}];
  let round = 1, current = 0, totalCorrect = 0, difficulty = 0;
  let pastCats = [];
  let usingDemo = true;

  const DEMO = [
    {category:"General Knowledge", question:"What color are Smurfs?", options:["Green","Blue","Red","Yellow"], correctIndex:1, explanation:"They are famously blue."},
    {category:"Science", question:"Water boils at what temperature at sea level?", options:["50°C","75°C","100°C","125°C"], correctIndex:2, explanation:"100°C at 1 atm."},
    {category:"Geography", question:"Which country has the most natural lakes?", options:["Finland","Canada","Russia","USA"], correctIndex:1},
    {category:"History", question:"The Magna Carta was signed in which year?", options:["1066","1215","1492","1776"], correctIndex:1},
    {category:"Literature", question:"Who wrote 'One Hundred Years of Solitude'?", options:["Borges","García Márquez","Llosa","Allende"], correctIndex:1},
    {category:"Science", question:"What's the chemical formula of ozone?", options:["O","O2","O3","O4"], correctIndex:2}
  ];
  let demoIdx = 0;

  const $ = sel => document.querySelector(sel);
  const el = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);
  const alpha = i => String.fromCharCode(65+i);

  function renderPills(){
    const wrap = $("#scorePills"); wrap.innerHTML = "";
    players.forEach((p,idx)=>{
      const pill = el("div",{className:"pill", textContent:`${p.name.slice(0,8)} ${p.score}`});
      if(idx===current) pill.style.background="#12315a";
      wrap.appendChild(pill);
    });
  }
  function setModeLabel(){ $("#modeLabel").textContent = `Mode: ${usingDemo?"Demo":"GPT"}`; }
  function setHeader(){
    $("#nowPlayer").textContent = players[current].name;
    $("#roundPill").textContent = `Round ${round}`;
    $("#diffPill").textContent = Difficulty[difficulty];
  }
  function showGame(){ $("#game").style.display = "block"; $("#results").style.display = "none"; }
  function showResults(){
    $("#game").style.display = "none"; $("#results").style.display = "block";
    const list = $("#scoreList"); list.innerHTML = "";
    [...players].sort((a,b)=>b.score-a.score).forEach(p=> list.appendChild(el("div",{textContent:`${p.name}: ${p.score}`})) );
  }

  async function nextQuestion(){
    if(round > cfg.rounds){ showResults(); return; }
    setHeader(); renderPills();
    const optionsWrap = $("#options"); optionsWrap.innerHTML = "";
    $("#feedback").textContent = "";

    let q;
    if(usingDemo || !cfg.proxy){
      q = DEMO[demoIdx++ % DEMO.length];
    } else {
      try{
        const res = await fetch(cfg.proxy, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ difficulty: Difficulty[difficulty].toLowerCase(), numOptions: cfg.options, avoidCategories: pastCats.slice(-4) })
        });
        q = await res.json();
      }catch(err){
        console.error(err); q = DEMO[demoIdx++ % DEMO.length]; usingDemo = true; setModeLabel();
      }
    }

    pastCats.push(q.category || "");
    $("#qCat").textContent = q.category || "";
    $("#qText").textContent = q.question;

    q.options.forEach((opt, idx)=>{
      const btn = el("button",{className:"option", innerHTML:`<div class='alpha'>${alpha(idx)}</div><div>${opt}</div>`});
      btn.onclick = ()=> submit(idx, q.correctIndex, q.explanation||"");
      optionsWrap.appendChild(btn);
    });
  }

  async function submit(idx, correctIndex, explanation){
    const options = [...document.querySelectorAll(".option")];
    options.forEach((b,i)=>{
      b.disabled = true;
      if(i===correctIndex) b.classList.add("right");
      if(i===idx && idx!==correctIndex) b.classList.add("wrong");
    });
    const ok = idx===correctIndex;
    $("#feedback").innerHTML = ok ? `<span style='color:var(--good)'>Correct!</span> ${explanation}` : `<span style='color:var(--bad)'>Not quite.</span> ${explanation}`;

    if(ok){
      players[current].score++;
      players[current].streak++;
      totalCorrect++;
      if(totalCorrect % 4 === 0 && difficulty < 4) difficulty++;
    } else {
      players[current].streak = 0;
      if(difficulty>1 && players.every(p=>p.streak===0)) difficulty--;
    }

    current = (current + 1) % players.length;
    if(current===0) round++;

    setTimeout(nextQuestion, 600);
  }

  $("#btnStart").onclick = ()=>{
    players[0].name = $("#name1").value.trim() || "Player 1";
    players[1].name = $("#name2").value.trim() || "Player 2";
    cfg.rounds = Math.max(6, Math.min(30, parseInt($("#rounds").value||"12")));
    cfg.proxy = $("#proxy").value.trim();
    usingDemo = !cfg.proxy;
    totalCorrect = 0; difficulty = 0; round = 1; current = 0; pastCats = [];
    players.forEach(p=>{p.score=0;p.streak=0});
    setModeLabel(); showGame(); nextQuestion();
  };
  $("#btnDemo").onclick = ()=>{ $("#proxy").value = ""; $("#btnStart").click(); };
  $("#btnSkip").onclick = ()=>{ current = (current+1)%players.length; if(current===0) round++; nextQuestion(); };
  $("#btnEnd").onclick = showResults;
  $("#btnRestart").onclick = ()=>{ document.scrollingElement.scrollTop = 0; $("#results").style.display="none" };

  let deferredPrompt;
  window.addEventListener("beforeinstallprompt", (e)=>{ e.preventDefault(); deferredPrompt = e; $("#btnInstall").style.display = "inline-block"; });
  $("#btnInstall").onclick = async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; deferredPrompt = null; $("#btnInstall").style.display="none"; };
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if(isIOS && !isStandalone){ $("#installHint").style.display = "inline-block"; }

 if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js?v=3").catch(console.warn);
}

</body>
</html>
